@model Myte.Models.Registro

@{
    ViewData["Title"] = "Registro de Horas";
}
@if (TempData["message"] != null)
{
    <script src="/lib/jquery/dist/jquery.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/js/toastr.min.js"></script>
    <script type="text/javascript">
        toastr.success('@TempData["message"]');
    </script>
}

<style>
    .background-image {
        position: absolute;
        top: 0;
        left: 0;
        z-index: -1;
        width: 100%;
        height: 100%;
        object-fit: cover;
        opacity: 0.7;
    }

    .text-center-btn {
        display: flex;
        justify-content: center;
        margin-top: 10px;
    }
</style>

<img src="~/IMG/IMG3.png" class="background-image" alt="Background Image">

<div class="container mt-2">
    <div class="row justify-content-center">
        <div class="col-lg-12">
            <div class="card">
                <div class="card-header bg-white text-black">
                    <h2 class="card-title text-center mb-0">REGISTRO DE HORAS</h2>
                </div>
                <hr />
                <div class="row justify-content-center">
                    <div class="col-md-8">
                        <form asp-action="Create">
                            <div asp-validation-summary="ModelOnly" class="text-danger"></div>
                            <div class="form-group text-center">
                                <label asp-for="FuncionarioId" class="control-label"><strong>ID Funcionário:</strong></label><br />
                                <select asp-for="FuncionarioId" class="form-control" asp-items="ViewBag.FuncionarioId"></select><br />
                            </div>
                            <div class="form-group text-center">
                                <label asp-for="DataRegistro" class="control-label"><strong>Data Registro:</strong></label><br />
                                <input asp-for="DataRegistro" class="form-control" id="startDate" />
                                <span asp-validation-for="DataRegistro" class="text-danger"></span><br />
                            </div>
                            <div class="form-group text-center">
                                <label asp-for="DataRegistro" class="control-label"><strong>Data Final:</strong></label><br />
                                <input type="date" class="form-control" id="endDate" />
                                <span asp-validation-for="DataRegistro" class="text-danger"></span><br />
                            </div>
                            <div class="form-group row text-center">
                                <div class="col-sm-12">
                                    <button type="button" class="btn btn-dark" onclick="generateTable()">Gerar Tabela</button>
                                </div>
                            </div>
                            <div class="form-group text-center">
                                <button type="submit" class="btn btn-primary" id="submitButton">Registrar</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container mt-5">
    <button class="btn btn-success mb-3" id="submitButton2" onclick="submitData()">Enviar Dados</button>
    <table class="table table-bordered" id="workHoursTable">
        <thead>
            <tr>
                <th>WBS</th>
                <!-- Date headers will be inserted here dynamically -->
            </tr>
        </thead>
        <tbody>
            <!-- Rows with task select and input fields for hours will be inserted here dynamically -->
        </tbody>
        <tfoot>
            <!-- Total hours row will be inserted here dynamically -->
        </tfoot>
    </table>
</div>

@section Scripts {
    <script>
        const submittedDataArray = [];
        let wbsOptions = '';

        function loadWBSOptions(callback) {
            $.ajax({
                type: 'GET',
                url: '@Url.Action("GetWBSOptions", "Registroes")',
                success: function (data) {
                    wbsOptions = '<option value="">None</option>';
                    data.forEach(wbs => {
                        wbsOptions += `<option value="${wbs.wbsId}">${wbs.codigo}</option>`;
                    });
                    if (callback) callback();
                },
                error: function (error) {
                    console.error('Erro ao carregar opções de WBS', error);
                }
            });
        }

        function generateTable() {
            // Limpar conteúdo anterior da tabela
            $('#workHoursTable thead tr').empty();
            $('#workHoursTable tbody').empty();
            $('#workHoursTable tfoot').empty();

            // Adicionar cabeçalho WBS
            $('#workHoursTable thead tr').append('<th>WBS</th>');

            // Obter datas de início e fim
            const startDate = new Date($('#startDate').val());
            const endDate = new Date($('#endDate').val());

            // Gerar cabeçalhos de datas
            const dates = [];
            let currentDate = startDate;
            while (currentDate <= endDate) {
                dates.push(new Date(currentDate));
                currentDate.setDate(currentDate.getDate() + 1);
            }

            dates.forEach(date => {
                const dateStr = date.toISOString().split('T')[0];
                $('#workHoursTable thead tr').append(`<th>${dateStr}</th>`);
            });

            // Gerar linhas
            for (let i = 0; i < 5; i++) { // Gerar 5 linhas como exemplo
                let row = `<tr><td><select class="form-control task-select">${wbsOptions}</select></td>`;
                dates.forEach(date => {
                    const day = date.getDay();
                    const isWeekend = (day === 5 || day === 6);
                    const inputField = `<td><input type="number" class="form-control hours-input${isWeekend ? ' disabled-input' : ''}"
                                            ${isWeekend ? 'disabled' : ''}
                                            min="0" max="24"
                                            data-date="${date.toISOString().split('T')[0]}"
                                            onchange="updateTotals('${date.toISOString().split('T')[0]}')">
                                    </td>`;
                    row += inputField;
                });
                row += '</tr>';
                $('#workHoursTable tbody').append(row);
            }

            // Adicionar linha de total
            let totalRow = '<tr><td>Total de horas trabalhadas</td>';
            dates.forEach(date => {
                const dateStr = date.toISOString().split('T')[0];
                totalRow += `<td id="total-${dateStr}">0</td>`;
            });
            totalRow += '</tr>';
            $('#workHoursTable tbody').append(totalRow);
        }

        function submitData() {
            if ($('#submitButton2').prop('disabled')) {
                alert("Não é permitido lançar mais de 12 horas por dia.");
                return;
            }

            const funcionarioId = $('#FuncionarioId').val();
            const tableData = [];
            const dates = [];
            $('#workHoursTable thead th').each(function (index) {
                if (index > 0) dates.push($(this).text());
            });

            $('#workHoursTable tbody tr').each(function () {
                const row = $(this);
                const wbs = row.find('select').val();
                if (wbs === undefined || wbs === "") {
                    console.error("WBS não selecionado para uma das linhas.");
                    return;
                }
                row.find('input[type="number"]').each(function (index) {
                    const hours = $(this).val();
                    if (hours) {
                        const date = dates[index];
                        tableData.push({ FuncionarioId: funcionarioId, WBSId: wbs, HorasTrab: hours, DataRegistro: date });
                    }
                });
            });

            $.ajax({
                type: 'POST',
                url: '@Url.Action("SaveData", "Registroes")',
                data: JSON.stringify(tableData),
                contentType: 'application/json; charset=utf-8',
                success: function (response) {
                    window.location.href = '@Url.Action("Index", "Registroes")';
                },
                error: function (xhr, status, error) {
                    console.error('Erro ao enviar dados:', status, error);
                    console.error('Resposta do servidor:', xhr.responseText);
                }
            });
        }

        function updateTotals(date) {
            let totalHours = 0;
            $(`input[data-date="${date}"]`).each(function () {
                totalHours += parseFloat($(this).val()) || 0;
            });

            $(`#total-${date}`).text(totalHours);

            if (totalHours > 12) {
                $(`input[data-date="${date}"]`).each(function () {
                    $(this).addClass('is-invalid');
                });
                alert("Não é permitido lançar mais de 12 horas por dia.");
                $('#submitButton').prop('disabled', true);
                $('#submitButton2').prop('disabled', true);
            } else {
                $(`input[data-date="${date}"]`).each(function () {
                    $(this).removeClass('is-invalid');
                });
                $('#submitButton').prop('disabled', false);
                $('#submitButton2').prop('disabled', false);
            }

            // Atualizar total de horas trabalhadas
            let totalTrabalhadas = 0;
            $(`#workHoursTable tbody tr`).not(':last').find(`input[data-date="${date}"]`).each(function () {
                totalTrabalhadas += parseFloat($(this).val()) || 0;
            });
            $(`#total-${date}`).text(totalTrabalhadas);
        }

        $(document).ready(function () {
            loadWBSOptions();
        });
    </script>
}
